# Feature-oriented Programming with JavaScript 特色導向程式開發
## Speaker: Fred Chien
### 記錄：胡學賓、張維元


國民機運動發起人，自由軟體開發者，並投入node 開發，嵌入式裝置/伺服器技術，如何融入node 並應用。

這場我們將要講的是，這是我自己翻譯的，特色導向程式開發，google 了一下，好像沒有人提這件事情，首先我要自己先提一件事情，這是昨天有人告訴我的，才臨時加了這個 slide，可以看到外面的海報（海報名字打錯），所以呢，這代表如果我接下來亂說話就不是我要講的。

還是自我介紹一下好了，我叫 Fred，大家對我比較有印象應該是上面這張照片，我自家這張可能會 shock，接下來你有什麼問都可以透過 email 聯絡我，網路上可以看到我，或是網路上 github。就跟剛剛主持人介紹一樣，我今年做了一個台灣國民機，如果你有興趣加入我們一起做手機的話，歡迎大家一起加入，有很多工作讓大家參與。 

我參與了很多 open source project，像是 LXDE，NPK，打爆你了 node project，這是我過去的一些經歷，現在做一些更多創業，所以我的經驗跟最近的 IOT 阿等等的都有關係。不過這不是今天的重點，今天的重點在立志，以 javascript 統一天下，這是我們大家的夢想，大家花了那麼多錢就是為了這件事情，希望 JSDC 成為語言第一大 conference，那我們從『佔中』，從佔領中研院開始。

## 緣起特色導向

那進入正題了啊，話說我最近東搞西搞，搞了一些有的沒的，從 APP，WEB ...後來就發現一件事情，什麼樣的事情呢？我自己重複做很多事情，同一件事情一直做，我相信大家也跟我一樣，如果大家有在寫一些 prokect 也會發現，第一個，像我寫了會員系統寫了 n 遍了，我看到要支援各種平台的登入，就覺得很麻煩，會員管理我也寫了 n 遍了，客戶永遠喜歡複雜的，各種權限控管，我相信大家都很痛苦，這些都重複寫了很多遍，我需要各種 API 各不同的系統使用，考慮開放第三方 API，我也寫了不知道多少遍，不只做純網站，像是嵌入式，或跟硬體有關係的，我需要給各種不同的硬體跟系統用，浪費我很多時間，非常痛苦，人家大學念完是青春的有為的青年，我卻是有為的大叔，客戶總是跟你要大便你就給他大便，但我總是便秘，人生的青春就這樣浪費掉了，因為我死阿宅，你可去試試看 google  翻譯：ZXN，連 google 都嘲笑你，不想變阿宅，就要少一點重複得事情不能做太多次。

堆積木的方法開發工作，所以我在網路上東看看西看看，有一天看到特色開發程式，是一篇1980 年代的論文，給資料庫或系統擴展的開發方式，直到近年才又有人聊起，不過沒有中文的文獻，簡稱 FOP，wiki上面的解釋又稱 FOSD，簡單來說什麼是 FOP，基本上可以用這個例子：你想做個雪人嗎？如果你是阿宅：我會先做骨幹，做隻腿，做頭，堆雪，裝飾，可是事實上呢？這是工程師阿宅的做法，可是一般人的作法是我直接堆個圓球就好了，放個鼻子跟眼睛就好了，所以我們很宅的原因在這邊，所以到底 FOP 是什麼呢？以 Feature 為本，Feature 就是你直覺想到的功能是什麼，那就是 Feature，像是雪人你會先想到一個大肚子，所以就堆個身體給他，再給他臉..等等的，也是一般人在堆積木的一種做法。

## 什麼是特色導向程式開發

FOP 以數學的定義來講的話就是：假設我們有一個feature叫 f，有一個 feature 叫h，我想把這兩個功能堆在一起，合成在一起的話，就是用 dot 把它們堆起來，把它們合在一個程式裡面，帶有 f、h 功能的一個，這是一個數學表示的方式，論文也是從這邊開始的，你寫了不同的元件，照這樣的方式 dot、dot 到無限，你就把程式寫完了，不像原本要拉來拉去，雖然已經 module了，不過拼起來還是很痛苦，規劃出一種方式很容易的拼起來，像積木一樣堆起來就完成了，我們也可以用一樣的方式，去結合去運行，照這樣做很像是軟體生產線一樣。fop 就像是程式生產線，血汗工廠，電腦不會跳樓，如果你更有興趣，也可以看一下這本書：『Feature Oriented Software Product lines』，講一些 FOP 的實作還有應用。

一般的語言沒有這樣的功能，會以 framework 的方式，像 C 這種比較底層的，有一個叫做 Feaure C++ 有這些特殊的功能可以去使用，那 javascript 有可能嗎？javascript 那麼動態，js + FOP ？，因為他太動態了，所以實現上很容易，為了實現這件事情，所以我們做一個簡單的框架，wag.js，去實作 fop 的架構。

我希望種下希望的種子，希望是如果能這樣就搞定，當然是最好的啊，把 feature 拼起來網站就好了，把以前做的功能串在一起就可以成一個網站好了，這樣網站的 service 就做完了，今天跟客戶結案明天就跟客戶收錢，當然這是大家心中的期望，這是幻想啦。

基本上我只要寫這樣幾個程式就做完了，前提是那些功能我都做完了，這樣的程式就是用 wag.js 去寫的東西，我把 web user useradimin 這三個模組 max-in 在一起像剛剛說的，把他們拼起來，在 FOP 裡面你要想每個東西都是 feature，大家可能聽過 OOP，OOP 就是裡面每個東西都是物件，FOP 反而比較沒有那麼的誇張，不像 OOP 那麼技術，他比較偏 feature，比較貼近一般人的思維，什麼東西都是 feature，把它們拼起來就就會變成一個新的 feature，就類似 package import ，做完這樣就很開心，可以跟客戶收錢，走路就搖擺了，這就是我為什麼取 wag.js 的原因。

## 應用方式及流程

底下的運作其實也是很簡單，你就把他們想像成每個功能都是一個 feature，把它們合起來變成一個新的 feature，會變成一個更大的 feature，最後程式會形成一個更大的樹狀結構，既然是以 feature 為本，所以我們就從剛剛圖看到，feature 究竟是怎麼樣的架構，如果我們要自己用 FOP 寫程式的話，其實很簡單嘛，這邊有一個範例，如果你是從 github 下載的話，可以得到這樣的範例，可以用這樣方式，事實上你也可以用 npm，最基本的 demo 就是像這個樣子，基本上我可以把兩個 js file 拼在一起，第一個是 mom.js，那它會顯示出一段文字（hellp mom），dad.js 也一樣，wag.js 就會把這兩個拼起來變成一個大的 prototype，執行的時候就會印出兩個結果來，你可以想像是有一個很大的 prototype 包含這兩個程式，可以想像成它有一點像繼承的味道，底下就是 prototype 的合成，他到底細節怎麼合成，我們可以注意他們的順序，我先  mixin 第一個是 Mom，第二個是 Dad，代表他們兩個是一個繼承的關係，可能是亂倫，在這範例裡面是 Dad 繼承 MOM，也就是母系社會嘛，實際是 mom 先被加進去的，有點像 dad 繼承  mom 的所有方法還有 prototype 的一些屬性以後，我再把 dad 的東西加上去。

假定大家前面有看到這樣一個東西，prototype 應該有講這是一個 constructor，當 prototype 被建立成一個新的 instance 的時候，他也會執行這個 function 做一個觸發，當然在執行這個function 的時候其實就是執行一個 super keyword，super 在 javascript 裡面沒有，所以我們設計一個這樣的 keyword，模擬 OOP 的繼承概念在裡面，這代表他呼叫前一個 constructor，就是帶自己的 prototype 這樣。

初始化的流程是這樣，拼成一個新的 feature 被建立的時候，他第一個會先執行 dad 的 constructor，剛剛的例子，dad 可以透過 super 去執行 mom 的 constructor。運用這的東西你可以做很多的功能，你可以取代或是去擴展他，假設我 dad 加了一個新的方法進去叫做 hello mom，是不是會跟 mom 衝突到，結果會變成 dad kill mom，原本那個就會不進，如果我只想要擴充他，那我一樣在 dad 加了一個新的方法顯示一段文字，那我可以用 super 的方式去呼叫前一個，他會先出現 dad 的一段文字在印出 mom 裡面的 hello mom 這段文字，結果會變成這樣的樣子，會在 hello mom執 行前插一段文字進去，這是一種擴充的方法，大量模仿 oop 的概念，希望所有東西都是合成變成一個方式，跟 OOP 不一樣的是，OOP 可能會有很多的 obj，在思考 obj 怎麼互相使用，FOP 這個方法希望最後都是回到樹狀的結構。

## 實際範例

這樣子有什麼好處呢？那我們寫網站試試看就知道了，如果你們已經有了 feature 了就可以這樣寫個網站，因為 wag.js 內建了一個 engine，你如果 install 好了之後，會內建一個這樣曉得 feature，如果有 wegjs 可以直接跑這段程式，裡面包的就是 express，這邊可以稍微 demo 一下，先進去 wag.js 的目錄，你會看到裡面有一些範例，你可以直接把 app.js 打開來看，我會內建一個 web，其實很簡單就是把 express 包起來，原則上跟 wag 不一定有關係

這是一個 web 的 feature，我執行一個 express，我為了這個 feature 加了一個方法進去，我在定一個 listen，裡面就會跑一些剛剛定義的 configure，route 等等。

接下來你要用到 express，你就繼承寫一個自己的 feature，依照剛剛的架構寫一個留言板，在一個 path 底下放很多 engine，大概的架構 appjs，engines。engines 目錄下放很多 engines （就是feature），更進一步的特定express，取代最原始的 web 的這個方法，第一個呢，我覺得剛剛那個回傳字串我不想要，設定寫完，就可以開始做事了。

我們我要加很多規則在這邊，所我我在路由這邊就放了很多設定的路徑進去，剛剛取代的幾乎都刪除了，再來就是有一個 super，call super 就是，我們看到這邊有個順序，他依賴這個順序，第一個是 web 再來是 gestbook，我用自定的 webengine 把它取代掉，下一步就是使用這個 engines，當我放進去之後，使用 suprer 就代表去 call 上一個方法，上一個方法就是自定的 web，當你呼叫這個就把路徑都清空了，這是一個這樣的概念，用了之後就會開始疊加規則上去，這邊就是所有的程式了，可以放 js，css，img，模版，這程式跑起來就是一個完整的留言板程式，這裡面已經放一些模版所以會有功能，這裡可以透過 route 去得到一些資訊。

## 增加更多新功能

所以回歸到剛剛，合成的順序是 web internal，接下來是你自定義的，如果有同名稱的模組想要疊加，可以指定很多路徑透過 addpath，他會透過這個設定把它一一讀出來，所以什麼東西都是合成一個物件，這就能了解 fop，他下一層有更多的合成。這段在講的是剛剛的留言板，他得建構子長這樣，設定變數陣列，裡面放很多留言資料沒有資料庫所以放在記憶體中，新增留言就加到陣列裡面，理論上功能都可以重複合成，做的事情都是疊起來的，所以東西不會有浪費的時候，當然要自己處理相依性的關係，所以建一個 MG149 是有可能的，你可以建一個相同的資料庫，功能可以互相分享，只要疊進去就可以用了。

wag 避免重複做同樣的事情，不同層都要有設定檔，所以我寫了這個東西（跟 FOP 沒有關係），你可以加一個 path，path 前面加一個目錄，啟動時就會載入，在這就可以看到範例，一個設定 prot  的 json，scope 裡有 setting，這是 jsonfile 名稱，web。json，裡面內容長這樣，可以去讀取，listen 就可以帶入設定，他直接支援 setting 的方式，開發者只要把設定都往 setting 值去丟就可以了

## 後續

你可以把這個問題簡單化，用疊層方式來使用，大家設定一個規則來開發一個流程，就像個產品線一樣，我目前也把把這些應用在自己做的專案中，把這概念放進來使用，所以有興趣或是有覺得有覺得可以加的話歡迎你加入，可以直接到 github 上找到，覺得很爛也可以跟我講，我是 ok 的，當然有別的興趣尤其是手機（快要做不完了），希望大家可以幫幫我，其實很多事情，辦活動，軟體硬體等等，如果對 json 有興趣也可以跟我做一些討論，另外每週四晚上都會在卡市達地方辦一個 party，我們會請講者來分享，我們都會聚在那邊，可以看 node taiwan 臉書公開資訊，那邊也會有打大食團，結束後會去逛逛街，整個晚上是很開心的

## Q&A

### Q1： 這概念跟我們寫一些 middleware 有什麼不一樣？

A1 其實感覺很像，middleware 他解決的是某一個程度上的產品線，當有個請求，我做了什麼事情，他希望程式每個角落都能夠用這樣方式去規劃，全部東西都用這概念去做。

### Q2：wag 概念用 mixin 是有先後順序繼承？如果不同模組有同樣名稱是否會覆寫掉前面的？

A2：對，先後順序有兩個部分，第一個是 mixin 順序的問題，第二個會依照 engine 的順序為主，super 的 keyword，不希望別人跟你用一樣的問題就不要用 super 把它取代掉，你可以用這樣去處理。目前這些範例都只有展示第一層，底下引入一些 engine進來，其實底下也是由 feature 所組成的，一樣的 database model 的話就需要進一步的管理，讓路徑合成的時候使用，就看你怎麼樣去管理，feature 裡面也可以建立子 feature，不過今天沒有時間講，可能之後文件也需要寫得比較清楚。所有東西就像積木一樣，可以拉進來拼起來，用合成的方式的去拼起來。

### Q3：一層剝一層的架構在 debug 上會不會有什麼問題，我有用過一個 C 的 library 有類似的功能，只印出最後一層的的 object，沒辦法去看出問題是什麼。

A3：剛剛有提到，每一層都是獨立的，所以每一層沒有非常相依性問題，雖然看起來好像合成一個 proto，實際上還是各自運作，所以在跑的時候會告訴你哪一層壞掉了，我知道很多作法都是合成一個 file，而我的作法是能讓你看到哪一層出錯，，雖然看起來好像合成，實際上各自物件還是獨立的 。
